import pwaConfig from './pwa.config'
import { APP_MANIFEST, SEO_CONFIG } from './app/constants/manifest'
import { CACHE_TTL } from './shared/commonEnums'
import { routeRules } from './shared/apiRoutes'

export default defineNuxtConfig({
  modules: [
    'shadcn-nuxt',
    '@vueuse/nuxt',
    '@nuxt/content',
    '@nuxt/eslint',
    '@nuxt/fonts',
    '@nuxt/image',
    '@pinia/nuxt',
    '@nuxtjs/tailwindcss',
    '@vite-pwa/nuxt',
    '@nuxtjs/device',
    '@nuxthub/core',
    'nuxt-auth-utils',
    '@nuxtjs/color-mode',
    'nuxt-security',
    '@nuxtjs/robots',
    '@nuxtjs/sitemap',
    'nuxt-schema-org',
    'nuxt-seo-utils',
    '@nuxtjs/turnstile',
  ],

  $development: {
    devtools: {
      enabled: true,
    },
    routeRules: routeRules,
    security: {
      strict: false,
      headers: {
        contentSecurityPolicy: false,
        permissionsPolicy: {
          fullscreen: ['self'],
        },
      },
      rateLimiter: false,
    },
  },

  $production: {
    app: {
      head: {
        title: APP_MANIFEST.name,
        link: [
          { rel: 'icon', href: '/favicon.ico', sizes: '48x48' },
          { rel: 'icon', href: '/favicon.svg', sizes: 'any', type: 'image/svg+xml' },
          { rel: 'apple-touch-icon', href: '/apple-touch-icon-180x180.png' },
        ],
      },
    },

    routeRules: routeRules,
    experimental: {
      payloadExtraction: false,
      emitRouteChunkError: 'automatic-immediate',
    },
    nitro: {
      compressPublicAssets: true,
      minify: true,
      preset: 'cloudflare-module',
      experimental: {
        openAPI: true,
        wasm: true,
      },
      cloudflare: {
        nodeCompat: true,
      },
      prerender: {
        crawlLinks: false, // set this to false so we do not bundle everything
        ignore: ['/admin', '/pwa', '/__og-image__/static/pwa'],
      },
      publicAssets: [
        {
          baseURL: 'content',
          dir: 'public/content',
          maxAge: CACHE_TTL.ONE_YEAR,
        },
        {
          baseURL: 'images',
          dir: 'public/images',
          maxAge: CACHE_TTL.ONE_YEAR,
        },
      ],
    },

    pwa: pwaConfig,
    security: {
      rateLimiter: false,
      strict: true,
      nonce: true,
      ssg: {
        hashScripts: true, // In the SSG case, inline scripts generated by the server will be allowed by hash
      },
      headers: {
        crossOriginOpenerPolicy: 'same-origin-allow-popups',
        crossOriginEmbedderPolicy: 'unsafe-none',
        contentSecurityPolicy: {
          'script-src': [
            '\'self\'',
            'https:',
            '\'unsafe-inline\'',
            '\'strict-dynamic\'',
            '\'nonce-{{nonce}}\'',
            '\'unsafe-eval\'',
          ],
          'style-src': ['\'self\'', 'https:', '\'unsafe-inline\''],
          'img-src': ['\'self\'', 'data:', 'https://*.gstatic.com'],
          'media-src': ['\'self\'', 'blob:'],
          'connect-src': ['\'self\''],
          'font-src': ['\'self\'', 'https://*.gstatic.com'],
          'worker-src': ['\'self\'', 'blob:'],
          'frame-src': ['\'self\'', 'https://www.youtube.com', 'https://challenges.cloudflare.com'],
        },
        permissionsPolicy: {
          'fullscreen': ['self'],
          'picture-in-picture': ['self'],
          'web-share': ['self'],
          'autoplay': ['self'],
        },
      },
    },
  },
  css: [
    '~/assets/css/tailwind.css',
  ],

  site: {
    url: 'nnsvn.me',
    name: APP_MANIFEST.name,
  },

  colorMode: {
    preference: 'system', // default value of $colorMode.preference
    fallback: 'light', // fallback value if not system preference found
    classSuffix: '',
    storage: 'cookie',
    disableTransition: true,
  },

  content: {
    build: {
      markdown: {
        highlight: false,
      },
    },
  },

  runtimeConfig: {
    public: {
      version: process.env.npm_package_version || '0.0.0',
      sentry: {
        dsn: '',
      },
    },
    turnstile: {
      secretKey: '',
    },
    defaultAdminPassword: '',
    session: {
      password: '',
    },
  },

  routeRules: {
    '/admin/**': {
      ssr: false,
    },
    '/settings/**': {
      ssr: false,
    },
  },

  sourcemap: {
    client: 'hidden',
  },

  compatibilityDate: '2026-01-30',

  nitro: {
    experimental: {
      tasks: true,
    },
    preset: 'cloudflare-module',
    cloudflare: {
      deployConfig: true,
      nodeCompat: true,
    },
  },

  hub: {
    // D1 database
    db: 'sqlite',
    // KV namespace (binding defaults to 'KV')
    kv: true,
    // Cache KV namespace (binding defaults to 'CACHE')
    cache: true,
    // R2 bucket (binding defaults to 'BLOB')
    blob: false,
  },

  auth: {
    webAuthn: true,
  },

  eslint: {
    config: {
      stylistic: {
        semi: false,
        quotes: 'single',
        indent: 2,
      },
    },
  },

  fonts: {
    families: [
      {
        name: 'Manrope',
        preload: true,
        provider: 'google',
        global: true,
      },
    ],
  },

  schemaOrg: {
    identity: 'Organization',
  },

  sentry: {
    sourceMapsUploadOptions: {
      org: 'no-name-studio',
      project: 'gromet-reader',
      authToken: process.env.SENTRY_AUTH_TOKEN,
    },
    silent: true,
    telemetry: false,
    sourcemaps: {
      filesToDeleteAfterUpload: '*.map',
    },
  },

  seo: {
    meta: {
      description: APP_MANIFEST.description,
      keywords: SEO_CONFIG.keywords,
      themeColor: APP_MANIFEST.theme_color,
      applicationName: APP_MANIFEST.short_name,
      appleMobileWebAppTitle: APP_MANIFEST.short_name,
      appleMobileWebAppCapable: 'yes',
      appleMobileWebAppStatusBarStyle: 'black-translucent',
      mobileWebAppCapable: 'yes',
      msapplicationTileColor: APP_MANIFEST.background_color,
      charset: 'utf-8',
      viewport: 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no',
      ogImage: '/pwa-512x512.png',
      twitterTitle: APP_MANIFEST.name,
      twitterDescription: APP_MANIFEST.description,
      twitterImage: '/pwa-512x512.png',
    },
  },

  shadcn: {
    prefix: '',
    componentDir: './app/components/ui',
  },

  sitemap: {
    zeroRuntime: true,
  },

  turnstile: {
    siteKey: process.env.NUXT_TURNSTILE_SITE_KEY,
  },
})
